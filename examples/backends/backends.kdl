// ============================================================================
// BACKENDS.KDL - Complete Example with All Features
// ============================================================================
// This file demonstrates all available backend configuration options.
// Copy relevant sections to ~/.config/declarch/backends.kdl
// ============================================================================

// =============================================================================
// COMMAND REFERENCE
// =============================================================================
// Required:
//   install "cmd {packages}"      - Install packages
//
// Optional (use "-" to disable without warning):
//   list "cmd" { ... }           - List installed packages
//   remove "cmd {packages}"       - Remove packages
//   update "cmd"                  - Update package index ("-" if not applicable)
//   upgrade "cmd"                 - Upgrade packages
//   cache_clean "cmd"             - Clean cache
//   search "cmd {query}" { ... }  - Search remote repos
//   search_local "cmd {query}" { ... } - Search installed packages
//
// Placeholders: {binary}, {packages}, {query}

// =============================================================================
// APT (Debian/Ubuntu)
// =============================================================================
backend "apt" {
    binary "apt"
    
    list "apt list --installed" {
        format regex
        pattern "^(\S+)/\S+\s+\S+\s+\[installed.*\]"
        name_group 1
    }
    
    install "apt install {packages}"
    remove "apt remove {packages}"
    update "apt update"
    upgrade "apt upgrade -y"
    cache_clean "apt clean"
    
    noconfirm "-y"
    needs_sudo true
}

// =============================================================================
// AUR Helper (paru/yay with pacman fallback)
// =============================================================================
backend "aur" {
    meta {
        title "AUR Helper"
        description "Meta backend for Arch User Repository"
        platforms "arch"
    }
    
    binary "paru" "yay"
    
    list "{binary} -Q" {
        format whitespace
        name_col 0
        version_col 1
    }
    
    install "{binary} -S --needed {packages}"
    remove "{binary} -R {packages}"
    update "{binary} -Sy"
    upgrade "{binary} -Syu"
    cache_clean "{binary} -Sc --noconfirm"
    
    search "{binary} -Ss {query}" {
        format regex
        regex "(?m)^(\\S+)\\s+.*\\n\\s+(.*)$"
        name_group 1
        desc_group 2
    }
    
    // Local search with format specification
    search_local "{binary} -Q {query}" {
        format whitespace
        name_col 0
        version_col 1
    }
    
    fallback "pacman"
}

// =============================================================================
// Flatpak
// =============================================================================
backend "flatpak" {
    binary "flatpak"
    
    list "flatpak list --app --columns=application,version" {
        format tsv
        name_col 0
        version_col 1
    }
    
    install "flatpak install flathub {packages}"
    remove "flatpak uninstall {packages}"
    update "flatpak update --appstream"
    upgrade "flatpak update -y"
    cache_clean "flatpak uninstall --unused -y"
    
    search "flatpak search {query}" {
        format tsv
        name_col 2
        desc_col 1
    }
    
    noconfirm "-y"
    needs_sudo false
}

// =============================================================================
// NPM (Node.js) - Example with sentinel value
// =============================================================================
backend "npm" {
    binary "npm"
    
    list "npm list -g --json" {
        format json
        json {
            path "dependencies"
            name_key "name"
            version_key "version"
        }
    }
    
    install "npm install -g --silent {packages}"
    remove "npm uninstall -g --silent {packages}"
    
    // NPM has no package index update - use "-" to disable without warning
    update "-"
    upgrade "npm update -g"
    cache_clean "npm cache clean --force"
    
    // Remote search
    search "npm search {query} --json" {
        format npm_json
        name_key "name"
        version_key "version"
        desc_key "description"
    }
    
    // Local search (in installed packages)
    search_local "npm list -g {query} --json" {
        format json
        json {
            path "dependencies"
            name_key "name"
            version_key "version"
        }
    }
    
    needs_sudo false
}

// =============================================================================
// Cargo (Rust) - Install-only backend example
// =============================================================================
// This backend can only install packages (no list/remove support)
backend "cargo" {
    meta {
        title "Cargo"
        description "Rust package manager (install-only)"
    }
    
    binary "cargo"
    
    // Install-only: no list_cmd, no remove_cmd
    install "cargo install {packages}"
    
    // Explicitly disable unsupported features
    list "-"
    remove "-"
    update "-"
    
    upgrade "cargo install {packages} --force"
    cache_clean "cargo cache --autoclean"
    
    needs_sudo false
}

// =============================================================================
// Import from separate files (recommended for many backends)
// =============================================================================
// imports {
//     "backends/custom.kdl"
// }
